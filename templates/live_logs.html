<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Logs</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-white h-screen w-full overflow-hidden">
    <div id="root" class="h-full w-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const LogItem = ({ log }) => {
            const getIcon = (type) => {
                switch (type) {
                    case 'error': return <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-red-500"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>;
                    case 'warning': return <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-amber-500"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></svg>;
                    case 'success': return <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-green-500"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>;
                    default: return <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-blue-500"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>;
                }
            };

            const getBgColor = (type) => {
                switch (type) {
                    case 'error': return 'bg-red-50/50 border-red-100 hover:bg-red-50';
                    case 'warning': return 'bg-amber-50/50 border-amber-100 hover:bg-amber-50';
                    case 'success': return 'bg-green-50/50 border-green-100 hover:bg-green-50';
                    default: return 'bg-white hover:bg-slate-50';
                }
            };

            const formatTime = (ts) => {
                if (!ts) return '';
                const date = new Date(ts);
                return date.toLocaleTimeString([], { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
            };

            return (
                <div className={`flex items-start gap-3 p-3 text-sm border-b border-slate-100 transition-colors ${getBgColor(log.type)}`}>
                    <div className="mt-0.5 shrink-0">
                        {getIcon(log.type)}
                    </div>
                    <div className="font-mono text-slate-400 text-xs mt-0.5 shrink-0 select-none w-20">
                        {formatTime(log.timestamp)}
                    </div>
                    <div className="flex-1 min-w-0 break-words">
                        <div className="font-medium text-slate-700">{log.message}</div>
                        {log.details && (
                            <div className="text-slate-500 text-xs mt-1 font-mono uppercase tracking-wide">
                                {log.details}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [logs, setLogs] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const scrollContainerRef = useRef(null);

            // Fetch Logs from Python API
            const fetchLogs = async () => {
                try {
                    // Cache buster ?t=... ensures we never get old cached data
                    const response = await fetch('/api/logs/live?t=' + Date.now());
                    if (!response.ok) throw new Error("API Error");
                    const data = await response.json();
                    
                    setLogs(data); 
                    setError(null);
                } catch (err) {
                    console.error("Fetch Error:", err);
                    // Don't show error on every poll to avoid flicker, just stop updating
                } finally {
                    setLoading(false);
                }
            };

            // Initial Load
            useEffect(() => {
                fetchLogs();
            }, []);

            // Polling Loop (Every 2 seconds)
            useEffect(() => {
                const interval = setInterval(fetchLogs, 2000);
                return () => clearInterval(interval);
            }, []);

            return (
                <div className="flex flex-col h-full bg-white">
                    {/* Header */}
                    <div className="flex-none p-2 border-b border-slate-200 flex justify-between items-center bg-slate-50">
                        <div className="flex items-center gap-2">
                             <span className="text-xs font-bold text-slate-500 uppercase tracking-wider">SQL Stream</span>
                             <div className={`w-2 h-2 rounded-full ${logs.length > 0 ? 'bg-green-500 animate-pulse' : 'bg-slate-300'}`}></div>
                        </div>
                        <span className="text-[10px] text-slate-400 font-mono">
                            {logs.length} entries
                        </span>
                    </div>

                    {/* Log List */}
                    <div ref={scrollContainerRef} className="flex-1 overflow-y-auto">
                         {loading && logs.length === 0 ? (
                             <div className="p-10 flex flex-col items-center justify-center text-slate-400 gap-2">
                                <span className="text-xs">Connecting...</span>
                             </div>
                         ) : logs.length === 0 ? (
                             <div className="p-10 text-center text-slate-400 text-sm">
                                Database is empty. <br/>
                                <span className="text-xs opacity-75">Click "Test Connection" to generate a log.</span>
                             </div>
                         ) : (
                             logs.map(log => <LogItem key={log.id} log={log} />)
                         )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
