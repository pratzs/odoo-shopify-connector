<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Logs</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* Hide scrollbar for Chrome, Safari and Opera */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        /* Hide scrollbar for IE, Edge and Firefox */
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
    </style>
</head>
<body class="bg-white h-screen w-full overflow-hidden">
    <div id="root" class="h-full w-full"></div>

    <script type="text/babel">
        // Import Firebase modules from CDN
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, query, where, orderBy, limit, onSnapshot, serverTimestamp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // --- Firebase Config (Injected by server or global vars) ---
        // NOTE: Ensure these variables are available. If running in the provided environment, they are global.
        // If running locally, replace these with your actual config object.
        const firebaseConfig = window.parent.__firebase_config ? JSON.parse(window.parent.__firebase_config) : JSON.parse(__firebase_config);
        const appId = window.parent.__app_id || (typeof __app_id !== 'undefined' ? __app_id : 'default-app-id');
        const initialAuthToken = window.parent.__initial_auth_token || (typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null);

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Components ---
        const { useState, useEffect, useRef } = React;

        const LogItem = ({ log }) => {
            const getIcon = (type) => {
                // Using SVG strings directly since Lucide React components aren't available in this CDN setup
                switch (type) {
                    case 'error': return <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-red-500"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>;
                    case 'warning': return <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-amber-500"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></svg>;
                    case 'success': return <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-green-500"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>;
                    default: return <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-blue-500"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>;
                }
            };

            const getBgColor = (type) => {
                switch (type) {
                    case 'error': return 'bg-red-50/50 border-red-100 hover:bg-red-50';
                    case 'warning': return 'bg-amber-50/50 border-amber-100 hover:bg-amber-50';
                    case 'success': return 'bg-green-50/50 border-green-100 hover:bg-green-50';
                    default: return 'bg-white hover:bg-slate-50';
                }
            };

            const formatTime = (ts) => {
                if (!ts) return 'Pending...';
                const date = ts.toDate ? ts.toDate() : new Date(ts);
                return date.toLocaleTimeString([], { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' }) + 
                    '.' + String(date.getMilliseconds()).padStart(3, '0');
            };

            return (
                <div className={`flex items-start gap-3 p-3 text-sm border-b border-slate-100 transition-colors ${getBgColor(log.type)}`}>
                    <div className="mt-0.5 shrink-0">
                        {getIcon(log.type)}
                    </div>
                    <div className="font-mono text-slate-400 text-xs mt-0.5 shrink-0 select-none w-24">
                        {formatTime(log.timestamp)}
                    </div>
                    <div className="flex-1 min-w-0 break-words">
                        <div className="font-medium text-slate-700">{log.message}</div>
                        {log.details && (
                            <div className="text-slate-500 text-xs mt-1 font-mono break-all">
                                {log.details}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [logs, setLogs] = useState([]);
            const [limitCount, setLimitCount] = useState(20);
            const [loading, setLoading] = useState(true);
            const [loadingMore, setLoadingMore] = useState(false);
            const [isSimulating, setIsSimulating] = useState(false);
            const scrollContainerRef = useRef(null);
            const simulationIntervalRef = useRef(null);

            useEffect(() => {
                const initAuth = async () => {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                };
                initAuth();
                return onAuthStateChanged(auth, setUser);
            }, []);

            useEffect(() => {
                if (!user) return;
                setLoading(true);
                const twentyFourHoursAgo = new Date();
                twentyFourHoursAgo.setHours(twentyFourHoursAgo.getHours() - 24);

                const q = query(
                    collection(db, 'artifacts', appId, 'public', 'data', 'logs'),
                    where('timestamp', '>=', twentyFourHoursAgo),
                    orderBy('timestamp', 'desc'),
                    limit(limitCount)
                );

                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const newLogs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setLogs(newLogs);
                    setLoading(false);
                    setLoadingMore(false);
                }, (err) => console.error("Firestore Error:", err));
                return () => unsubscribe();
            }, [user, limitCount]);

            const handleScroll = (e) => {
                const { scrollTop, scrollHeight, clientHeight } = e.target;
                if (scrollHeight - scrollTop <= clientHeight + 50) {
                    if (!loadingMore && !loading && logs.length >= limitCount) {
                        setLoadingMore(true);
                        setLimitCount(prev => prev + 20);
                    }
                }
            };

            const addLog = async (message, type = 'info', details = '') => {
                if (!user) return;
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'logs'), {
                    message, type, details, timestamp: serverTimestamp(), userId: user.uid
                });
            };

            const toggleSimulation = () => {
                if (isSimulating) {
                    clearInterval(simulationIntervalRef.current);
                    setIsSimulating(false);
                } else {
                    setIsSimulating(true);
                    simulationIntervalRef.current = setInterval(() => {
                        const types = ['info', 'warning', 'success', 'error'];
                        const msgs = ["Order #1234 Synced", "Inventory Update", "API Latency High", "Customer Updated"];
                        addLog(msgs[Math.floor(Math.random()*msgs.length)], types[Math.floor(Math.random()*types.length)]);
                    }, 2000);
                }
            };

            return (
                <div className="flex flex-col h-full bg-white">
                    {/* Minimal Toolbar */}
                    <div className="flex-none p-2 border-b border-slate-200 flex justify-between items-center bg-slate-50">
                        <span className="text-xs font-bold text-slate-500 uppercase tracking-wider">Live Feed</span>
                        <div className="flex gap-2">
                             <span className={`text-xs px-2 py-0.5 rounded-full flex items-center gap-1 ${logs.length > 0 ? 'bg-green-100 text-green-700' : 'bg-slate-100 text-slate-500'}`}>
                                <span className={`w-1.5 h-1.5 rounded-full ${logs.length > 0 ? 'bg-green-500 animate-pulse' : 'bg-slate-400'}`}></span>
                                {logs.length}
                            </span>
                             <button onClick={toggleSimulation} className="text-xs text-indigo-600 hover:text-indigo-800 font-medium">
                                {isSimulating ? 'Stop' : 'Test Stream'}
                            </button>
                        </div>
                    </div>

                    {/* Scrollable Area */}
                    <div ref={scrollContainerRef} onScroll={handleScroll} className="flex-1 overflow-y-auto">
                         {loading && logs.length === 0 ? (
                             <div className="p-4 text-center text-slate-400 text-xs">Loading stream...</div>
                         ) : logs.length === 0 ? (
                             <div className="p-10 text-center text-slate-400 text-sm">No recent logs</div>
                         ) : (
                             logs.map(log => <LogItem key={log.id} log={log} />)
                         )}
                         {loadingMore && <div className="p-2 text-center text-xs text-slate-400">Loading older...</div>}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
